<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stellar Mobile - Precision Mode</title>
    <style>
        :root {
            --space-black: #050508;
            --star-cyan: #00f2ff;
            --glass: rgba(12, 12, 20, 0.95);
            --accent: #00f2ff;
        }

        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }

        /* Mira Central */
        #crosshair {
            position: fixed; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border: 1px solid var(--star-cyan);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 50;
            border-radius: 50%;
        }
        #crosshair::after, #crosshair::before {
            content: ''; position: absolute; background: var(--star-cyan);
        }
        #crosshair::after { top: 50%; left: -10px; width: 40px; height: 1px; }
        #crosshair::before { left: 50%; top: -10px; width: 1px; height: 40px; }

        /* Botão de Marcar Ponto */
        #btn-mark {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 70%; height: 55px;
            background: var(--star-cyan); color: #000;
            border: none; border-radius: 30px;
            font-weight: bold; font-size: 1.1em;
            z-index: 100; box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
        }

        #sidebar { 
            position: fixed; left: 0; top: 0; width: 85%; height: 100vh; 
            background: var(--glass); padding: 20px; box-sizing: border-box; 
            z-index: 1000; transform: translateX(-100%); transition: 0.3s;
        }
        #sidebar.active { transform: translateX(0); }

        #menu-toggle {
            position: fixed; top: 20px; right: 20px; width: 50px; height: 50px;
            background: rgba(255,255,255,0.1); color: #fff; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            z-index: 999; border: 1px solid rgba(255,255,255,0.2);
        }

        #custom-modal { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #111; padding: 25px; border: 1px solid var(--star-cyan); z-index: 2000; display: none; width: 80%; border-radius: 12px; }
        #custom-modal.active { display: block; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: #fff; box-sizing: border-box; }
        
        .map-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 10px; display: flex; justify-content: space-between; }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<div id="crosshair"></div>
<button id="btn-mark" onclick="markCenterPoint()">MARCAR PONTO AQUI</button>
<button id="menu-toggle" onclick="toggleSidebar()">☰</button>

<div id="sidebar">
    <h2 style="color:var(--star-cyan);">STELLAR PRO</h2>
    <div id="map-list" style="overflow-y:auto; flex-grow:1"></div>
    <button onclick="openModal('map')">+ NOVO SETOR</button>
    <button onclick="clearAllData()" style="color:#ff4757; border-color:#ff4757">RESETAR TUDO</button>
</div>

<div id="custom-modal">
    <h3 id="modal-title" style="color:var(--star-cyan)">NOMEAR</h3>
    <input type="text" id="modal-input" placeholder="ID do ponto...">
    <div style="display:flex; gap:10px;">
        <button onclick="confirmModal()" style="background:var(--star-cyan); color:#000; padding:10px; border:none; flex:1">SALVAR</button>
        <button onclick="closeModal()" style="color:#fff; border:none; flex:1">CANCELAR</button>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const sidebar = document.getElementById('sidebar');
const modal = document.getElementById('custom-modal');
const modalInput = document.getElementById('modal-input');

let maps = JSON.parse(localStorage.getItem('stellar_prec_v1')) || {}; 
let currentMapName = localStorage.getItem('last_prec_map') || null;
let points = (currentMapName && maps[currentMapName]) ? [...maps[currentMapName]] : [];
let camera = { x: 0, y: 0, zoom: 1 };
let isDragging = false;
let lastTouchPos = { x: 0, y: 0 };
let currentModalType = null;
let pendingPointData = null;

// CORREÇÃO DE DPI
function setupCanvas() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    ctx.scale(dpr, dpr);
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
}

function init() {
    setupCanvas();
    window.onresize = setupCanvas;
    renderMapList();
    draw();
}

function markCenterPoint() {
    if(!currentMapName) { alert("Crie um setor no menu primeiro!"); return; }
    // O ponto é o centro da tela (0,0 em relação à câmera)
    const x = -camera.x;
    const y = -camera.y;
    pendingPointData = {x, y};
    openModal('point');
}

function toggleSidebar() { sidebar.classList.toggle('active'); }
function openModal(type) { currentModalType = type; modal.classList.add('active'); modalInput.focus(); }
function closeModal() { modal.classList.remove('active'); modalInput.value = ""; }

function confirmModal() {
    const val = modalInput.value.trim();
    if (currentModalType === 'map' && val) { maps[val] = []; switchMap(val); }
    else if (currentModalType === 'point' && pendingPointData) { 
        points.push({ ...pendingPointData, label: val || `P-${points.length + 1}` }); 
        saveCurrentMap();
    }
    closeModal();
    sidebar.classList.remove('active');
}

function renderMapList() {
    const list = document.getElementById('map-list');
    list.innerHTML = '';
    Object.keys(maps).forEach(name => {
        const div = document.createElement('div');
        div.className = 'map-item';
        div.innerHTML = `<span>${name.toUpperCase()}</span> <span onclick="deleteMap('${name}', event)">✖</span>`;
        div.onclick = () => { switchMap(name); toggleSidebar(); };
        list.appendChild(div);
    });
}

function switchMap(name) { currentMapName = name; points = [...maps[name]]; localStorage.setItem('last_prec_map', name); renderMapList(); }
function saveCurrentMap() { if(currentMapName) { maps[currentMapName] = points; localStorage.setItem('stellar_prec_v1', JSON.stringify(maps)); } }
function clearAllData() { if(confirm("Apagar tudo?")) { localStorage.clear(); location.reload(); } }
function deleteMap(name, e) { e.stopPropagation(); delete maps[name]; saveCurrentMap(); renderMapList(); }

function draw() {
    ctx.fillStyle = "#050508";
    ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
    
    ctx.save();
    ctx.translate(window.innerWidth/2 + camera.x * camera.zoom, window.innerHeight/2 + camera.y * camera.zoom);
    ctx.scale(camera.zoom, camera.zoom);

    // Linhas de conexão
    if (points.length > 1) {
        ctx.beginPath(); ctx.strokeStyle = "rgba(0, 242, 255, 0.3)"; ctx.lineWidth = 2;
        ctx.moveTo(points[0].x, points[0].y);
        points.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();
    }

    // Pontos
    points.forEach(p => {
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
        ctx.font = "bold 12px Arial"; ctx.fillStyle = "#00f2ff"; ctx.textAlign = "center";
        ctx.fillText(p.label.toUpperCase(), p.x, p.y - 15);
    });

    ctx.restore();
    requestAnimationFrame(draw);
}

// TOUCH NAVIGATION (APENAS MOVER)
canvas.addEventListener('touchstart', e => {
    isDragging = true;
    lastTouchPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
});

canvas.addEventListener('touchmove', e => {
    if (!isDragging) return;
    const touch = e.touches[0];
    camera.x += (touch.clientX - lastTouchPos.x) / camera.zoom;
    camera.y += (touch.clientY - lastTouchPos.y) / camera.zoom;
    lastTouchPos = { x: touch.clientX, y: touch.clientY };
});

canvas.addEventListener('touchend', () => isDragging = false);

init();
</script>
</body>
</html>
